name: ðŸš€ Cross-Framework Test Automation CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run tests daily at 2 AM UTC
    - cron: '0 2 * * *'

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  test:
    name: ðŸ§ª Cross-Framework Testing
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [20.x]
      fail-fast: false
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ðŸŸ¢ Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: â˜• Setup Java (for Allure)
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '11'
        
    - name: ðŸ”§ Install Allure CLI
      run: npm install -g allure-commandline
        
    - name: ðŸ“¦ Install Dependencies
      run: npm run install:all
      
    - name: ðŸŽ­ Install Playwright Browsers
      run: cd playwright && npx playwright install --with-deps
      
    - name: ðŸ“ Create Allure Results Directories
      run: |
        mkdir -p allure-results
        mkdir -p cypress/allure-results
        mkdir -p playwright/allure-results
        mkdir -p selenium/allure-results
      
    - name: ðŸŽ­ Run Playwright Tests (with retry)
      uses: nick-fields/retry@v3
      with:
        timeout_minutes: 10
        max_attempts: 2
        retry_on: error
        command: npm run playwright:allure
        
    - name: ðŸ”§ Run Selenium Tests (with retry)
      uses: nick-fields/retry@v3
      with:
        timeout_minutes: 10
        max_attempts: 2
        retry_on: error
        command: npm run selenium:allure
        
    - name: ðŸŒ² Run Cypress Tests (with retry)
      uses: nick-fields/retry@v3
      with:
        timeout_minutes: 10
        max_attempts: 2
        retry_on: error
        command: npm run cypress:allure
      
    - name: ðŸ“Š Generate Unified Allure Report
      run: npm run allure:generate
      if: always()
      
    - name: ðŸ“¤ Upload Allure Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: allure-results-20.x
        path: allure-results/
        retention-days: 30
        
    - name: ðŸ“¤ Upload Allure Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: allure-report-20.x
        path: allure-report/
        retention-days: 30

  deploy-report:
    name: ðŸš€ Deploy Allure Report
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ðŸ“¥ Download Allure Report
      uses: actions/download-artifact@v4
      with:
        name: allure-report-20.x
        path: allure-report/
        
    - name: ðŸ“„ Setup Pages
      uses: actions/configure-pages@v4
      
    - name: ðŸ“¤ Upload Pages Artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./allure-report
        
    - name: ðŸš€ Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
        
  notify:
    name: ðŸ“¢ Pipeline Status Notification
    needs: [test, deploy-report]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: ðŸ“Š Determine Test Results
      id: test-results
      run: |
        # Get test job status
        TEST_STATUS="${{ needs.test.result }}"
        
        # Create test results JSON
        echo "{
          \"Playwright\": $([ "$TEST_STATUS" == "success" ] && echo true || echo false),
          \"Selenium\": $([ "$TEST_STATUS" == "success" ] && echo true || echo false),
          \"Cypress\": $([ "$TEST_STATUS" == "success" ] && echo true || echo false)
        }" > test_results.json
        
        # Set status output
        if [ "$TEST_STATUS" == "success" ]; then
          echo "status=success" >> $GITHUB_OUTPUT
        elif [ "$TEST_STATUS" == "cancelled" ]; then
          echo "status=cancelled" >> $GITHUB_OUTPUT
        else
          echo "status=failure" >> $GITHUB_OUTPUT
        fi

    - name: ðŸ“¢ Send Slack Notification
      run: node .github/workflows/slack-notify-ci.js "${{ steps.test-results.outputs.status }}" "$(cat test_results.json)"
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
